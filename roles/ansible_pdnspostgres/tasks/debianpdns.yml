---
- name: Install PowerDNS packages
  apt:
          name: pdns-server, pdns-tools, pdns-backend-pgsql, postgresql, postgresql-client
#- name: Enable PowerDNS Service
#  command: rc-update add pdns
#- name: Enable Postgresql Service
#  command: rc-update add postgresql
#- name: Create /etc/ansible/facts.d
#  file:
#          path: /etc/ansible/facts.d
#          state: directory
#- name: Copy pdns db check
#  copy:
#          src: dbexist.fact
#          dest: /etc/ansible/facts.d/dbexist.fact
#          owner: jochen
#          group: jochen
#          mode: 0740
- name: Copy pdns config file
  template:
          src: pdns.conf.debian.j2
          dest: /etc/powerdns/pdns.conf
          owner: "{{ pdnssetuid }}"
          group: "{{ pdnssetgid }}"
          mode: 0640
          backup: yes
#- name: create pdns db
#  command: "psql -c 'CREATE DATABASE pdns;'"
#  become: yes
#  become_user: postgres
- name: Enable PostgreSQL Service
  service:
          name: postgresql
          enabled: yes
          state: started
- name: Enable pdns Service
  service:
          name: pdns
          enabled: yes
- name: create pgsql backup directory in /opt/pg_dump
  file:
          path: /opt/pg_dump
          state: directory
          owner: postgres
          group: root
          mode: '0770'
- name: Setup pgsql cron job runbackup
  cron:
          name: runbackup
          minute: 0
          hour: 0
          job: sudo -u postgres /usr/bin/pg_dump pdns > /opt/pg_dump/pdns_backup.sql

